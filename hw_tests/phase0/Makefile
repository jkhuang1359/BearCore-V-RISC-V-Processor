# BearCore-V Stage 0 ç¡¬ä»¶æµ‹è¯• Makefile

CROSS_COMPILE = riscv64-unknown-elf-
CC = $(CROSS_COMPILE)gcc
OBJCOPY = $(CROSS_COMPILE)objcopy
OBJDUMP = $(CROSS_COMPILE)objdump
CFLAGS = -march=rv32i -mabi=ilp32 -nostdlib -nostartfiles -O0 -g
LDFLAGS = -T link.ld

# æµ‹è¯•ç›®æ ‡
TESTS = minimal_test test jump_test csr_test alu_comprehensive control_flow memory_test

.PHONY: all clean compile simulate check

all: compile simulate check

# ç¼–è¯‘æ‰€æœ‰æµ‹è¯•
compile: $(addsuffix .hex, $(TESTS))

# ç¼–è¯‘å•ä¸ªæµ‹è¯•
%.hex: %.s
$(CC) $(CFLAGS) $(LDFLAGS) -o $*.elf $<
$(OBJCOPY) -O binary $*.elf $*.bin
od -An -tx4 -w4 -v $*.bin > $*.hex
$(OBJDUMP) -d $*.elf > $*.disasm
@echo "âœ… ç¼–è¯‘: $*"

# è¿è¡Œä»¿çœŸ
simulate: $(addsuffix .vcd, $(TESTS))

%.vcd: %.hex
@echo "ğŸš€ ä»¿çœŸ: $*"
cp $*.hex ../../firmware.hex
cd ../.. && iverilog -o wave.vvp -f files.f -I src
cd ../.. && vvp wave.vvp +testname=$* > logs/$*.log 2>&1
@echo "âœ… ä»¿çœŸå®Œæˆ: $*"

# æ£€æŸ¥ç»“æœ
check:
@echo "ğŸ“Š æ£€æŸ¥æµ‹è¯•ç»“æœ..."
@for test in $(TESTS); do \
 "TEST_PASS\|PASS\|SUCCESS" ../../logs/$$test.log 2>/dev/null; then \
 "TEST_FAIL\|FAIL\|ERROR" ../../logs/$$test.log 2>/dev/null; then \
e

# æ¸…ç†
clean:
rm -f *.elf *.bin *.hex *.disasm
rm -f ../../firmware.hex ../../wave.vvp
@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# è¯¦ç»†ä»¿çœŸ
debug_%: %.hex
cp $*.hex ../../firmware.hex
cd ../.. && iverilog -o wave.vvp -f files.f -I src
cd ../.. && vvp wave.vvp +verbose=1 +testname=$*

