## 1. 总体架构
### 1.1 设计目标
- 实现RISC-V RV32IM指令集
- 5级流水线设计
- 完整M-mode特权架构支持
- 可综合的Verilog实现

### 1.2 系统框图
┌─────────────────────────────────────────────┐
│ BearCore-V Core │
├─────────────────────────────────────────────┤
│ +---------------------------------------+ │
│ │ 5-Stage Pipeline │ │
│ │ IF → ID → EX → MEM → WB │ │
│ +---------------------------------------+ │
│ +---------------------------------------+ │
│ │ Control Unit │ │
│ │ • Hazard Detection │ │
│ │ • Forwarding Logic │ │
│ │ • Exception Control │ │
│ +---------------------------------------+ │
│ +---------------------------------------+ │
│ │ CSR Subsystem │ │
│ │ • M-mode CSR Registers │ │
│ │ • Interrupt Controller │ │
│ │ • Timer Unit │ │
│ +---------------------------------------+ │
└─────────────────────────────────────────────┘

text

## 2. 流水线设计
### 2.1 流水线阶段
| 阶段 | 功能 | 主要模块 |
|------|------|----------|
| IF | 指令获取 | PC寄存器、指令ROM |
| ID | 指令解码 | 解码器、寄存器文件 |
| EX | 执行 | ALU、分支判断、CSR操作 |
| MEM | 访存 | 数据RAM、MMIO接口 |
| WB | 写回 | 寄存器写回、CSR结果 |

### 2.2 冒险处理
- **数据冒险**: 通过前推(Forwarding)解决
- **控制冒险**: 通过分支预测(总是不跳转)和流水线暂停解决
- **结构冒险**: 独立的指令和数据存储器

## 3. 指令集实现
### 3.1 RV32I基础指令
- 算术运算: ADD, SUB, AND, OR, XOR, SLT, SLTU
- 移位运算: SLL, SRL, SRA
- 分支跳转: BEQ, BNE, BLT, BGE, BLTU, BGEU, JAL, JALR
- 访存指令: LW, SW, LH, LB, LHU, LBU, SH, SB
- 其他指令: LUI, AUIPC

### 3.2 M扩展指令
- 乘法: MUL
- 除法: DIV, DIVU
- 取余: REM, REMU

### 3.3 CSR指令
- CSRRW, CSRRS, CSRRC
- CSRRWI, CSRRSI, CSRRCI

## 4. 存储器系统
### 4.1 地址空间
| 地址范围 | 类型 | 描述 |
|----------|------|------|
| 0x00000000-0x00003FFF | 指令ROM | 16KB程序存储器 |
| 0x00010000-0x0001FFFF | 数据RAM | 64KB数据存储器 |
| 0x10000000-0x1000000F | MMIO | UART外设 |
| 0x20000000-0x2000000F | MMIO | 定时器 |

### 4.2 内存映射
- 指令和数据分离(Harvard架构)
- 外设通过内存映射IO访问
- 32位地址空间，支持4GB寻址

## 5. CSR系统
### 5.1 M-mode CSR寄存器
| CSR地址 | 名称 | 功能 |
|---------|------|------|
| 0x300 | mstatus | 机器模式状态寄存器 |
| 0x301 | misa | 指令集架构信息 |
| 0x304 | mie | 机器模式中断使能 |
| 0x305 | mtvec | 异常向量基地址 |
| 0x340 | mscratch | 机器模式暂存寄存器 |
| 0x341 | mepc | 异常程序计数器 |
| 0x342 | mcause | 异常原因 |
| 0x343 | mtval | 异常值 |
| 0x344 | mip | 中断等待寄存器 |

### 5.2 中断处理
- **中断源**: 定时器、软件、外部中断
- **优先级**: 固定优先级，定时器最高
- **向量模式**: 直接模式，所有异常跳转到mtvec
- **嵌套中断**: 支持中断嵌套处理

## 6. 外设接口
### 6.1 UART接口
- 波特率: 115200
- 数据位: 8位
- 停止位: 1位
- 无校验位
- 地址: 0x10000000 (数据), 0x10000004 (状态)

### 6.2 定时器
- 64位定时器计数器(mtime)
- 64位比较寄存器(mtimecmp)
- 定时器中断支持

## 7. 性能特征
### 7.1 时序特性
- 5级流水线，理想CPI=1
- 实际CPI≈1.2 (包含分支惩罚)
- 关键路径: EX阶段ALU运算

### 7.2 面积估计
| 模块 | 逻辑门数 | 百分比 |
|------|----------|--------|
| 控制单元 | 800 | 20% |
| 数据通路 | 1500 | 37.5% |
| CSR单元 | 300 | 7.5% |
| 存储器接口 | 400 | 10% |
| 其他 | 1000 | 25% |
| **总计** | **4000** | **100%** |

## 8. 验证策略
### 8.1 验证方法
- 指令级模拟器(ILS)验证
- Verilog功能仿真
- CSR功能专项测试
- 性能基准测试

### 8.2 测试覆盖率
- 指令覆盖: 100% RV32IM指令
- CSR覆盖: 100% M-mode CSR
- 异常覆盖: 主要异常类型
- 中断覆盖: 所有中断源

## 9. 设计考虑
### 9.1 可扩展性
- 模块化设计，易于添加新功能
- CSR系统支持扩展自定义CSR
- 外设接口标准化，易于添加新外设

### 9.2 可综合性
- 同步设计，单时钟域
- 无异步复位问题
- 标准Verilog语法，兼容主流工具

## 10. 未来扩展
### 10.1 短期计划
- 添加S-mode和U-mode支持
- 实现页表转换(TLB)
- 添加更多外设接口

### 10.2 长期计划
- 多核扩展
- 缓存系统设计
- 高级分支预测

---
*文档版本: 1.0*
*更新日期: $(date)*