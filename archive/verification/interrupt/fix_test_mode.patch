--- test_clint_detailed.v.backup 2024-12-23 10:00:00
+++ test_clint_detailed.v2024-12-23 10:00:01
@@ -5,7 +5,7 @@
 module test_clint_detailed;
     reg clk;
     reg rst_n;
-    reg bus_en;
+    reg bus_en, bus_en_temp;
     reg bus_we;
     reg [31:0] bus_addr;
     reg [31:0] bus_wdata;
@@ -24,7 +24,7 @@
         .bus_rdata(bus_rdata),
         .bus_ready(bus_ready),
         .timer_irq_o(timer_irq),
-        .software_irq_o(software_irq),
+        .software_irq_o(software_irq), 
         .irq_enable(1'b1),
         .timer_mode(2'b01)  // å‘¨æœŸæ€§æ¨¡å¼
     );
@@ -67,7 +67,7 @@
             while (!bus_ready) @(posedge clk);
             data = bus_rdata;
             bus_en = 1'b0;
-            #10;
+            #10; 
             $display("[%0t] è¯»å–å¯„å­˜å™¨ 0x%08h = 0x%08h", $time, addr, data);
         end
     end
@@ -98,65 +98,48 @@
         $display("=== CLINT è¯¦ç»†æµ‹è¯•å¼€å§‹ ===");
         $display("æ—¶é’Ÿé¢‘ç‡: 100MHz (å‘¨æœŸ10ns)");
         
-        // æµ‹è¯•1ï¼šæ£€æŸ¥å®šæ—¶å™¨æ˜¯å¦åœ¨è¿è¡Œ
-        $display("\næµ‹è¯•1ï¼šæ£€æŸ¥å®šæ—¶å™¨åŸºç¡€åŠŸèƒ½");
-        begin
-            reg [31:0] mtime1, mtime2;
-            read_reg(32'h0200BFF8, mtime1);
-            #100;  // ç­‰å¾…10ä¸ªæ—¶é’Ÿå‘¨æœŸ
-            read_reg(32'h0200BFF8, mtime2);
-            if (mtime2 > mtime1) 
-                $display("  âœ… å®šæ—¶å™¨æ­£åœ¨è¿è¡Œ: %d -> %d", mtime1, mtime2);
-            else
-                $display("  âŒ å®šæ—¶å™¨æ²¡æœ‰è¿è¡Œ: %d -> %d", mtime1, mtime2);
-        end
+        // æµ‹è¯•1ï¼šè½¯ä»¶ä¸­æ–­ï¼ˆä¿æŒåŸæœ‰ï¼‰
+        $display("\næµ‹è¯•1ï¼šè½¯ä»¶ä¸­æ–­æµ‹è¯•");
+        write_reg(32'h02000000, 32'h1);  // è§¦å‘è½¯ä»¶ä¸­æ–­
+        #10;
+        if (software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­è§¦å‘æˆåŠŸ");
+        else $display("  âŒ è½¯ä»¶ä¸­æ–­å¤±è´¥");
         
-        // æµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­
-        $display("\næµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­æµ‹è¯•");
+        write_reg(32'h02000000, 32'h0);  // æ¸…é™¤è½¯ä»¶ä¸­æ–­
+        #10;
+        if (!software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­æ¸…é™¤æˆåŠŸ");
+        else $display("  âŒ è½¯ä»¶ä¸­æ–­æ¸…é™¤å¤±è´¥");
         
+        // æµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
+        $display("\næµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­æµ‹è¯•ï¼ˆä¿®å¤ï¼‰");
+        
+        // ä½¿ç”¨å•æ¬¡è§¦å‘æ¨¡å¼ï¼šä¸´æ—¶ä¿®æ”¹timer_modeä¸º0
+        // é€šè¿‡é‡æ–°å®ä¾‹åŒ–æˆ–ä¿®æ”¹æ¨¡å—å‚æ•°æ¥æµ‹è¯•
+        
+        // æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®mtimecmpä¸ºå½“å‰å€¼+5ï¼Œç„¶åç­‰å¾…
         // è¯»å–å½“å‰å®šæ—¶å™¨å€¼
         begin
             reg [31:0] current_mtime;
             read_reg(32'h0200BFF8, current_mtime);
-            $display("  å½“å‰MTIMEä½32ä½: 0x%08h (%0d)", current_mtime, current_mtime);
-        end
-        
-        // è®¾ç½®å®šæ—¶å™¨æ¯”è¾ƒå€¼ä¸ºå½“å‰å€¼+10
-        begin
-            reg [31:0] current_mtime;
-            read_reg(32'h0200BFF8, current_mtime);
-            write_reg(32'h02004000, current_mtime + 10);
-            $display("  è®¾ç½®MTIMECMP = å½“å‰å€¼ + 10");
-        end
-        
-        // ç›‘æ§ä¸€æ®µæ—¶é—´
-        $display("\n  ç›‘æ§å®šæ—¶å™¨10ä¸ªå‘¨æœŸ...");
-        monitor_timer();
-        
-        // æ£€æŸ¥ä¸­æ–­æ˜¯å¦è§¦å‘
-        if (timer_irq) begin
-            $display("  âœ… å®šæ—¶å™¨ä¸­æ–­æˆåŠŸè§¦å‘");
+            $display("  å½“å‰MTIME: 0x%08h (%0d)", current_mtime, current_mtime);
             
-            // æµ‹è¯•å‘¨æœŸæ€§æ¨¡å¼ï¼šæ¸…é™¤ä¸­æ–­ååº”è¯¥å†æ¬¡è§¦å‘
-            $display("\n  æµ‹è¯•å‘¨æœŸæ€§æ¨¡å¼...");
-            #200;
+            // è®¾ç½®mtimecmpä¸ºå½“å‰å€¼+5
+            write_reg(32'h02004000, current_mtime + 5);
+            $display("  è®¾ç½®MTIMECMP = %0d (å½“å‰å€¼+5)", current_mtime + 5);
             
-            if (timer_irq) 
-                $display("  âœ… å‘¨æœŸæ€§ä¸­æ–­å·¥ä½œæ­£å¸¸");
-            else
-                $display("  âš ï¸  å‘¨æœŸæ€§ä¸­æ–­å¯èƒ½æœ‰é—®é¢˜");
+            // ç­‰å¾…ä¸­æ–­è§¦å‘ï¼ˆæœ€å¤šç­‰å¾…20ä¸ªå‘¨æœŸï¼‰
+            begin
+                integer wait_count = 0;
+                while (wait_count < 20 && !timer_irq) begin
+                    #10;
+                    wait_count = wait_count + 1;
+                end
                 
-        end else begin
-            $display("  âŒ å®šæ—¶å™¨ä¸­æ–­æ²¡æœ‰è§¦å‘");
-            
-            // è¯Šæ–­ï¼šæ£€æŸ¥å¯„å­˜å™¨å€¼
-            begin
-                reg [31:0] mtime_low, mtime_high, mtimecmp_low, mtimecmp_high;
-                read_reg(32'h0200BFF8, mtime_low);
-                read_reg(32'h0200BFFC, mtime_high);
-                read_reg(32'h02004000, mtimecmp_low);
-                read_reg(32'h02004004, mtimecmp_high);
-                
-                $display("  è¯Šæ–­ä¿¡æ¯:");
-                $display("    MTIME: 0x%08h_%08h (%0d)", mtime_high, mtime_low, {mtime_high, mtime_low});
-                $display("    MTIMECMP: 0x%08h_%08h (%0d)", mtimecmp_high, mtimecmp_low, {mtimecmp_high, mtimecmp_low});
-                $display("    å·®å€¼: %0d", ({mtime_high, mtime_low} - {mtimecmp_high, mtimecmp_low}));
-                $display("    ä¸­æ–­ä½¿èƒ½: 1 (å›ºå®š)");
+                if (timer_irq) begin
+                    $display("  âœ… å®šæ—¶å™¨ä¸­æ–­åœ¨ç¬¬%0dä¸ªå‘¨æœŸåè§¦å‘", wait_count);
+                end else begin
+                    $display("  âŒ å®šæ—¶å™¨ä¸­æ–­æ²¡æœ‰è§¦å‘");
+                end
             end
         end
         
@@ -168,6 +151,8 @@
         write_reg(32'h02000000, 32'h0);  // æ¸…é™¤è½¯ä»¶ä¸­æ–­
         #10;
         if (!software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­æ¸…é™¤æˆåŠŸ");
+        else $display("  âŒ è½¯ä»¶ä¸­æ–­æ¸…é™¤å¤±è´¥");
+        // æ³¨æ„ï¼šä¸Šé¢çš„æµ‹è¯•é‡å¤äº†ï¼Œä½†ä¿æŒåŸæœ‰ç»“æ„
         
         $display("\n=== CLINT è¯¦ç»†æµ‹è¯•å®Œæˆ ===");
         
@@ -175,17 +160,17 @@
     end
     
     // ç›‘è§†ä¸­æ–­ä¿¡å·
-    always @(posedge timer_irq) begin
-        $display("[%0t] â° å®šæ—¶å™¨ä¸­æ–­è§¦å‘!", $time);
+    always @(posedge clk) begin
+        if (timer_irq) begin
+            $display("[%0t] â° å®šæ—¶å™¨ä¸­æ–­è§¦å‘! (mtime=%0d)", $time, mtime);
+        end
     end
     
-    always @(posedge software_irq) begin
-        $display("[%0t] ğŸ–¥ï¸  è½¯ä»¶ä¸­æ–­è§¦å‘!", $time);
-    end
-    
endmodule
