--- a/src/core.v
+++ b/src/core.v
@@ -78,6 +78,7 @@ module core(
     reg [1:0] mem_csr_op;
     reg mem_csr_use_imm;
     reg [11:0] mem_csr_addr;    
+    reg [31:0] mem_csr_wdata;  // 新增：在MEM階段保存CSR寫入數據
 
     // MEM/WB 流水線寄存器中的 CSR 相關信號
     reg wb_is_csr, wb_is_system;
@@ -262,6 +263,7 @@ module core(
             mem_is_csr <= ex_is_csr;
             mem_is_system <= ex_is_system;
             mem_csr_op <= ex_csr_op;
+            mem_csr_wdata <= (ex_csr_use_imm) ? ex_imm : fwd_rs1;  // 在EX階段計算，MEM階段使用
             mem_csr_use_imm <= ex_csr_use_imm;
             mem_csr_addr <= ex_csr_addr;            
         end
@@ -430,10 +432,10 @@ module core(
                         wb_alu_result;
 
     // 5. CSR 寫入數據選擇
-    wire [31:0] csr_wdata_temp = ex_csr_use_imm  ? ex_imm : fwd_rs1;
-    assign csr_wdata = csr_wdata_temp;
+    // CSR寫入數據現在在MEM階段使用mem_csr_wdata
+    assign csr_wdata = mem_csr_wdata;
     assign csr_we = mem_is_csr && (mem_csr_op == 2'b00 || |csr_wdata);
-    
+
     // 調試寄存器寫入
     always @(posedge clk) begin
         if (wb_reg_wen && wb_rd_addr == 5'b01011) begin  // a1 是 x11
@@ -460,7 +462,7 @@ module core(
 
     // 調試 CSR 數據流
     always @(posedge clk) begin
-        if (ex_is_csr && ex_csr_addr == 12'h340) begin
+        if (mem_is_csr && mem_csr_addr == 12'h340) begin
             $display("[CSR-FLOW-DEBUG] EX stage: csr_wdata=0x%h, ex_csr_use_imm=%b, fwd_rs1=0x%h, ex_imm=0x%h",
                     csr_wdata, ex_csr_use_imm, fwd_rs1, ex_imm);
         end
@@ -476,37 +478,16 @@ module core(
         end
     end    
 
-    // ========== 關鍵 CSR 調試 ==========
+    // ========== 修正後的CSR調試 ==========
     always @(posedge clk) begin
-        // 追蹤 CSR 指令在流水線中的流動
-        if (id_is_csr) begin
-            $display("[PIPELINE-CSR] ID: addr=0x%h, rs1=%d, rd=%d, imm=%b, op=%b",
-                    id_csr_addr, id_rs1_addr, id_rd_addr, id_csr_use_imm, id_csr_op);
+        if (mem_is_csr && mem_csr_addr == 12'h340) begin
+            $display("[CSR-MEM-DEBUG] addr=0x340, wdata=0x%h, we=%b, op=%b, mem_csr_wdata=0x%h",
+                    mem_csr_addr, csr_wdata, csr_we, mem_csr_op, mem_csr_wdata);
         end
         
-        if (ex_is_csr) begin
-            $display("[PIPELINE-CSR] EX: addr=0x%h, wdata=0x%h, we=%b, fwd_rs1=0x%h",
-                    ex_csr_addr, csr_wdata, csr_we, fwd_rs1);
+        if (csr_we && mem_csr_addr == 12'h340) begin
+            $display(">>> CSR ACTUAL WRITE: 0x%h -> CSR[0x340]", csr_wdata);
         end
-        
-        if (mem_is_csr) begin
-            $display("[PIPELINE-CSR] MEM: addr=0x%h, rdata=0x%h, we=%b, reg_wen=%b",
-                    mem_csr_addr, csr_rdata, csr_we, mem_reg_wen);
-            if (csr_we) begin
-                $display(">>> CSR ACTUAL WRITE: 0x%h -> CSR[0x%h]", csr_wdata, mem_csr_addr);
-            end
-        end
-        
-        // 追蹤寄存器寫入
-        if (wb_reg_wen && wb_rd_addr == 11) begin
-            $display("[REG-TRACE] a1 written: 0x%h at PC=0x%h", wb_reg_wdata, wb_pc);
-        end
-    end
-
-    // 實時監控 CSR 狀態
-    always @(posedge clk) begin
-        static integer csr_340_value = 0;
-        if (csr_we && mem_csr_addr == 12'h340) begin
-            csr_340_value = csr_wdata;
-            $display("!!! CSR[0x340] UPDATED: 0x%h (was 0x%h)", csr_wdata, csr_340_value);
-        end
     end    
                         
 endmodule
