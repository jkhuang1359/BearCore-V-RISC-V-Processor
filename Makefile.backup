# Makefile
CROSS_COMPILE = riscv64-unknown-elf-
CC = $(CROSS_COMPILE)gcc
OBJCOPY = $(CROSS_COMPILE)objcopy

CFLAGS = -march=rv32im -mabi=ilp32 -O0 -g -nostdlib -nostartfiles -ffreestanding -I./src/include
LDFLAGS = -T link.ld

# 默認目標
all: firmware.hex

# 標準編譯
firmware.elf: src/start.s src/main.c
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o $@

csr_simple_test: tests/csr_simple_test.s tests/csr_simple_test.c
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o firmware.elf
	$(OBJCOPY) -O binary firmware.elf firmware.bin
	od -An -t x4 -w4 -v firmware.bin | tr -d ' ' > firmware.hex

test_csr_simple: csr_simple_test
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp	

# CSR全面测试
CSR_COMPREHENSIVE_SRC = tests/csr_comprehensive_test.s tests/csr_comprehensive_test.c

csr_comprehensive_test: $(CSR_COMPREHENSIVE_SRC)
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o firmware.elf
	$(OBJCOPY) -O binary firmware.elf firmware.bin
	od -An -t x4 -w4 -v firmware.bin | tr -d ' ' > firmware.hex

test_csr_comprehensive: csr_comprehensive_test
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp	

CSR_TEST_SRC = tests/csr_minimal_test.c

csr_detailed_test: tests/csr_detailed_test.s tests/csr_simplest_test.c
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o firmware.elf
	$(OBJCOPY) -O binary firmware.elf firmware.bin
	od -An -t x4 -w4 -v firmware.bin | tr -d ' ' > firmware.hex

csr_simplest_test: src/start.s tests/csr_simplest_test.c
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o firmware.elf
	$(OBJCOPY) -O binary firmware.elf firmware.bin
	od -An -t x4 -w4 -v firmware.bin | tr -d ' ' > firmware.hex

csr_minimal_test: $(CSR_TEST_SRC)
	$(CC) $(CFLAGS) -T link.ld src/start.s $(CSR_TEST_SRC) -o firmware.elf
	$(OBJCOPY) -O binary firmware.elf firmware.bin
	od -An -t x4 -w4 -v firmware.bin | tr -d ' ' > firmware.hex

test_csr_minimal: csr_minimal_test
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp	

test_csr_simplest: csr_simplest_test
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp	

test_csr_detailed: csr_detailed_test
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp		

# CSR 測試
csr_test: src/start.s tests/csr_simple_test.c
	$(CC) $(CFLAGS) $(LDFLAGS) $^ -o firmware.elf

# 生成 hex 文件
firmware.bin: firmware.elf
	$(OBJCOPY) -O binary $< $@

firmware.hex: firmware.bin
	od -An -t x4 -w4 -v $< | tr -d ' ' > $@

clean:
	rm -f *.elf *.bin *.hex *.vvp

sim: firmware.hex
	iverilog -g2012 -o wave.vvp -f files.f && vvp wave.vvp

.PHONY: all clean sim csr_test