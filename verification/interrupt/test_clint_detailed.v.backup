`timescale 1ns/1ps

module test_clint_detailed;
    reg clk;
    reg rst_n;
    reg bus_en;
    reg bus_we;
    reg [31:0] bus_addr;
    reg [31:0] bus_wdata;
    wire [31:0] bus_rdata;
    wire bus_ready;
    wire timer_irq;
    wire software_irq;
    
    // å®ä¾‹åŒ–CLINT
    clint u_clint (
        .clk(clk),
        .rst_n(rst_n),
        .bus_en(bus_en),
        .bus_we(bus_we),
        .bus_addr(bus_addr),
        .bus_wdata(bus_wdata),
        .bus_rdata(bus_rdata),
        .bus_ready(bus_ready),
        .timer_irq_o(timer_irq),
        .software_irq_o(software_irq),
        .irq_enable(1'b1),
        .timer_mode(2'b01)  // å‘¨æœŸæ€§æ¨¡å¼
    );
    
    // æ—¶é’Ÿç”Ÿæˆ
    always #5 clk = ~clk;
    
    // æµ‹è¯•ä»»åŠ¡ï¼šå†™å…¥å¯„å­˜å™¨
    task write_reg;
        input [31:0] addr;
        input [31:0] data;
        begin
            @(posedge clk);
            bus_en = 1'b1;
            bus_we = 1'b1;
            bus_addr = addr;
            bus_wdata = data;
            @(posedge clk);
            while (!bus_ready) @(posedge clk);
            bus_en = 1'b0;
            bus_we = 1'b0;
            #10;
            $display("[%0t] å†™å…¥å¯„å­˜å™¨ 0x%08h = 0x%08h", $time, addr, data);
        end
    endtask
    
    // æµ‹è¯•ä»»åŠ¡ï¼šè¯»å–å¯„å­˜å™¨
    task read_reg;
        input [31:0] addr;
        output [31:0] data;
        begin
            @(posedge clk);
            bus_en = 1'b1;
            bus_we = 1'b0;
            bus_addr = addr;
            @(posedge clk);
            while (!bus_ready) @(posedge clk);
            data = bus_rdata;
            bus_en = 1'b0;
            #10;
            $display("[%0t] è¯»å–å¯„å­˜å™¨ 0x%08h = 0x%08h", $time, addr, data);
        end
    endtask
    
    // ç›‘æ§å®šæ—¶å™¨å€¼
    task monitor_timer;
        integer i;
        begin
            for (i = 0; i < 10; i = i + 1) begin
                #100;  // æ¯100ä¸ªæ—¶é—´å•ä½æ£€æŸ¥ä¸€æ¬¡
                begin
                    reg [31:0] mtime_low, mtime_high, mtimecmp_low;
                    read_reg(32'h0200BFF8, mtime_low);
                    read_reg(32'h0200BFFC, mtime_high);
                    read_reg(32'h02004000, mtimecmp_low);
                    $display("[%0t] MTIME=0x%08h_%08h, MTIMECMPä½32ä½=0x%08h, timer_irq=%b", 
                             $time, mtime_high, mtime_low, mtimecmp_low, timer_irq);
                end
            end
        end
    endtask
    
    initial begin
        $dumpfile("clint_detailed_test.vcd");
        $dumpvars(0, test_clint_detailed);
        
        // åˆå§‹åŒ–
        clk = 0;
        rst_n = 0;
        bus_en = 0;
        bus_we = 0;
        bus_addr = 0;
        bus_wdata = 0;
        
        // å¤ä½
        #20 rst_n = 1;
        
        $display("=== CLINT è¯¦ç»†æµ‹è¯•å¼€å§‹ ===");
        $display("æ—¶é’Ÿé¢‘ç‡: 100MHz (å‘¨æœŸ10ns)");

        // æµ‹è¯•1ï¼šè½¯ä»¶ä¸­æ–­ï¼ˆä¿æŒåŸæœ‰ï¼‰
        $display("\næµ‹è¯•1ï¼šè½¯ä»¶ä¸­æ–­æµ‹è¯•");
        write_reg(32'h02000000, 32'h1);  // è§¦å‘è½¯ä»¶ä¸­æ–­
        #10;
        if (software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­è§¦å‘æˆåŠŸ");
        else $display("  âŒ è½¯ä»¶ä¸­æ–­å¤±è´¥");        
        
        // æµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        $display("\næµ‹è¯•2ï¼šå®šæ—¶å™¨ä¸­æ–­æµ‹è¯•ï¼ˆä¿®å¤ï¼‰");
        
        // ä½¿ç”¨å•æ¬¡è§¦å‘æ¨¡å¼ï¼šä¸´æ—¶ä¿®æ”¹timer_modeä¸º0
        // é€šè¿‡é‡æ–°å®ä¾‹åŒ–æˆ–ä¿®æ”¹æ¨¡å—å‚æ•°æ¥æµ‹è¯•        
        // æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®mtimecmpä¸ºå½“å‰å€¼+5ï¼Œç„¶åç­‰å¾…

        
        // è¯»å–å½“å‰å®šæ—¶å™¨å€¼
        begin
            reg [31:0] current_mtime;
            read_reg(32'h0200BFF8, current_mtime);
            $display("  å½“å‰MTIMEä½32ä½: 0x%08h (%0d)", current_mtime, current_mtime);
        end
        
        // è®¾ç½®å®šæ—¶å™¨æ¯”è¾ƒå€¼ä¸ºå½“å‰å€¼+10
        begin
            reg [31:0] current_mtime;
            read_reg(32'h0200BFF8, current_mtime);
            write_reg(32'h02004000, current_mtime + 10);
            write_reg(32'h02004004, 32'h00000000);  // è®¾ç½®é«˜32ä½ä¸º0
            $display("  è®¾ç½®MTIMECMP = å½“å‰å€¼ + 10");
        end
        
        // ç›‘æ§ä¸€æ®µæ—¶é—´
        $display("\n  ç›‘æ§å®šæ—¶å™¨10ä¸ªå‘¨æœŸ...");
        monitor_timer();
        
        // æ£€æŸ¥ä¸­æ–­æ˜¯å¦è§¦å‘
        if (timer_irq) begin
            $display("  âœ… å®šæ—¶å™¨ä¸­æ–­æˆåŠŸè§¦å‘");
            
            // æµ‹è¯•å‘¨æœŸæ€§æ¨¡å¼ï¼šæ¸…é™¤ä¸­æ–­ååº”è¯¥å†æ¬¡è§¦å‘
            $display("\n  æµ‹è¯•å‘¨æœŸæ€§æ¨¡å¼...");
            #200;
            
            if (timer_irq) 
                $display("  âœ… å‘¨æœŸæ€§ä¸­æ–­å·¥ä½œæ­£å¸¸");
            else
                $display("  âš ï¸  å‘¨æœŸæ€§ä¸­æ–­å¯èƒ½æœ‰é—®é¢˜");
                
        end else begin
            $display("  âŒ å®šæ—¶å™¨ä¸­æ–­æ²¡æœ‰è§¦å‘");
            
            // è¯Šæ–­ï¼šæ£€æŸ¥å¯„å­˜å™¨å€¼
            begin
                reg [31:0] mtime_low, mtime_high, mtimecmp_low, mtimecmp_high;
                read_reg(32'h0200BFF8, mtime_low);
                read_reg(32'h0200BFFC, mtime_high);
                read_reg(32'h02004000, mtimecmp_low);
                read_reg(32'h02004004, mtimecmp_high);
                
                $display("  è¯Šæ–­ä¿¡æ¯:");
                $display("    MTIME: 0x%08h_%08h (%0d)", mtime_high, mtime_low, {mtime_high, mtime_low});
                $display("    MTIMECMP: 0x%08h_%08h (%0d)", mtimecmp_high, mtimecmp_low, {mtimecmp_high, mtimecmp_low});
                $display("    å·®å€¼: %0d", ({mtime_high, mtime_low} - {mtimecmp_high, mtimecmp_low}));
                $display("    ä¸­æ–­ä½¿èƒ½: 1 (å›ºå®š)");
            end
        end
        
        // æµ‹è¯•3ï¼šè½¯ä»¶ä¸­æ–­
        $display("\næµ‹è¯•3ï¼šè½¯ä»¶ä¸­æ–­æµ‹è¯•");
        write_reg(32'h02000000, 32'h1);  // è§¦å‘è½¯ä»¶ä¸­æ–­
        #10;
        if (software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­è§¦å‘æˆåŠŸ");
        else $display("  âŒ è½¯ä»¶ä¸­æ–­å¤±è´¥");
        
        write_reg(32'h02000000, 32'h0);  // æ¸…é™¤è½¯ä»¶ä¸­æ–­
        #10;
        if (!software_irq) $display("  âœ… è½¯ä»¶ä¸­æ–­æ¸…é™¤æˆåŠŸ");
        else $display("  âŒ è½¯ä»¶ä¸­æ–­æ¸…é™¤å¤±è´¥");
        
        $display("\n=== CLINT è¯¦ç»†æµ‹è¯•å®Œæˆ ===");
        
        #100 $finish;
    end
    
    // ç›‘è§†ä¸­æ–­ä¿¡å·
    always @(posedge timer_irq) begin
        $display("[%0t] â° å®šæ—¶å™¨ä¸­æ–­è§¦å‘!", $time);
    end
    
    always @(posedge software_irq) begin
        $display("[%0t] ğŸ–¥ï¸  è½¯ä»¶ä¸­æ–­è§¦å‘!", $time);
    end
    
endmodule
